# Sprint 23: Code Quality Checks
# Runs on every PR to ensure code quality standards

name: Code Quality

on:
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================================================
  # PR Validation
  # ============================================================================
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

  # ============================================================================
  # Backend Quality
  # ============================================================================
  backend-quality:
    name: Backend Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          pip install bandit safety pylint

      - name: Run security scan with bandit
        working-directory: ./backend-django
        run: |
          bandit -r fhir_api/ -ll -ii -x "**/tests/**"
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        working-directory: ./backend-django
        run: |
          safety check -r requirements.txt
        continue-on-error: true

      - name: Run pylint
        working-directory: ./backend-django
        run: |
          pylint fhir_api/ --disable=C0114,C0115,C0116,E0401,C0301 --max-line-length=120
        continue-on-error: true

  # ============================================================================
  # Frontend Quality
  # ============================================================================
  frontend-quality:
    name: Frontend Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-pwa/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend-pwa
        run: npm ci

      - name: Check for outdated dependencies
        working-directory: ./frontend-pwa
        run: npm outdated || true

      - name: Audit dependencies
        working-directory: ./frontend-pwa
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check bundle size
        working-directory: ./frontend-pwa
        run: |
          npm run build
          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Documentation Check
  # ============================================================================
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation
        run: |
          # Check that README exists
          if [ ! -f "README.md" ]; then
            echo "::error::README.md is missing"
            exit 1
          fi
          
          # Check for API documentation
          echo "Checking documentation..."
          
          echo "## Documentation Status" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for file in README.md CONTRIBUTING.md LICENSE; do
            if [ -f "$file" ]; then
              echo "| $file | ✅ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $file | ❌ |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # ============================================================================
  # Commit Messages
  # ============================================================================
  commitlint:
    name: Commit Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install commitlint
        run: |
          npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Validate commits
        run: |
          echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }}
        continue-on-error: true
